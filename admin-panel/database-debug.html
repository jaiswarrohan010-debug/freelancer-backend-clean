<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .input-group {
            margin: 10px 0;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .user-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .user-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .user-field {
            margin: 5px 0;
            font-size: 14px;
        }
        .user-field strong {
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Database Debug Tool</h1>
        <p>This tool helps debug database issues, especially email field constraints.</p>
    </div>

    <!-- Authentication Section -->
    <div class="container">
        <div class="section">
            <h3>üîê Admin Authentication</h3>
            <div class="input-group">
                <input type="text" id="adminUsername" placeholder="Admin Username" value="admin">
                <input type="password" id="adminPassword" placeholder="Admin Password" value="admin123">
                <button onclick="authenticateAdmin()">Login</button>
            </div>
            <div id="authStatus" class="log"></div>
        </div>
    </div>

    <!-- Database Analysis Section -->
    <div class="container">
        <div class="section">
            <h3>üìä Database Analysis</h3>
            <button onclick="analyzeDatabase()">Analyze All Users</button>
            <button onclick="findDuplicateEmails()">Find Duplicate Emails</button>
            <button onclick="findNullEmails()">Find Null Emails</button>
            <button onclick="checkUserSchema()">Check User Schema</button>
            <div id="dbAnalysis" class="log"></div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="container">
        <div class="section">
            <h3>üë• User Management</h3>
            <div class="input-group">
                <input type="text" id="searchPhone" placeholder="Search by Phone Number">
                <button onclick="searchUser()">Search User</button>
            </div>
            <div class="input-group">
                <input type="text" id="deleteUserId" placeholder="User ID to Delete">
                <button onclick="deleteUser()" style="background: #dc3545;">Delete User</button>
            </div>
            <div id="userManagement" class="log"></div>
        </div>
    </div>

    <!-- Test Authentication Section -->
    <div class="container">
        <div class="section">
            <h3>üß™ Test Authentication</h3>
            <div class="input-group">
                <input type="text" id="testPhone" placeholder="Phone Number to Test" value="+917021098460">
                <input type="text" id="testRole" placeholder="Role" value="freelancer">
                <button onclick="testAuthentication()">Test Auth</button>
            </div>
            <div id="testResults" class="log"></div>
        </div>
    </div>

    <!-- Database Fix Section -->
    <div class="container">
        <div class="section">
            <h3>üîß Database Fixes</h3>
            <button onclick="cleanupNullEmails()" style="background: #ffc107; color: black;">Cleanup Null Emails</button>
            <button onclick="removeEmailField()" style="background: #dc3545;">Remove Email Field (Dangerous)</button>
            <button onclick="resetDatabase()" style="background: #dc3545;">Reset Database (Dangerous)</button>
            <div id="fixResults" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://freelancer-backend-jv21.onrender.com/api';
        let adminToken = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        async function authenticateAdmin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            log('authStatus', 'üîê Authenticating admin...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.token) {
                    adminToken = data.token;
                    log('authStatus', '‚úÖ Admin authentication successful', 'success');
                    log('authStatus', `Token: ${adminToken.substring(0, 20)}...`, 'info');
                } else {
                    log('authStatus', `‚ùå Authentication failed: ${data.message}`, 'error');
                }
            } catch (error) {
                log('authStatus', `‚ùå Authentication error: ${error.message}`, 'error');
            }
        }

        async function analyzeDatabase() {
            if (!adminToken) {
                log('dbAnalysis', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            log('dbAnalysis', 'üìä Analyzing database...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('dbAnalysis', `‚úÖ Found ${data.verifications.length} users`, 'success');
                    
                    data.verifications.forEach((user, index) => {
                        log('dbAnalysis', `User ${index + 1}:`, 'info');
                        log('dbAnalysis', `  ID: ${user._id}`, 'info');
                        log('dbAnalysis', `  Name: ${user.name}`, 'info');
                        log('dbAnalysis', `  Phone: ${user.phone}`, 'info');
                        log('dbAnalysis', `  Email: ${user.email || 'NOT SET'}`, 'info');
                        log('dbAnalysis', `  Verified: ${user.isVerified}`, 'info');
                        log('dbAnalysis', `  Status: ${user.verificationStatus}`, 'info');
                        log('dbAnalysis', `  Created: ${user.createdAt}`, 'info');
                        log('dbAnalysis', '---', 'info');
                    });
                } else {
                    log('dbAnalysis', `‚ùå Failed to fetch users: ${data.message}`, 'error');
                }
            } catch (error) {
                log('dbAnalysis', `‚ùå Analysis error: ${error.message}`, 'error');
            }
        }

        async function findDuplicateEmails() {
            if (!adminToken) {
                log('dbAnalysis', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            log('dbAnalysis', 'üîç Searching for duplicate emails...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const emailCounts = {};
                    const duplicateEmails = [];
                    
                    data.verifications.forEach(user => {
                        const email = user.email || 'null';
                        emailCounts[email] = (emailCounts[email] || 0) + 1;
                    });
                    
                    Object.entries(emailCounts).forEach(([email, count]) => {
                        if (count > 1) {
                            duplicateEmails.push({ email, count });
                        }
                    });
                    
                    if (duplicateEmails.length > 0) {
                        log('dbAnalysis', `‚ö†Ô∏è Found ${duplicateEmails.length} duplicate email patterns:`, 'warning');
                        duplicateEmails.forEach(({ email, count }) => {
                            log('dbAnalysis', `  Email: "${email}" appears ${count} times`, 'warning');
                        });
                    } else {
                        log('dbAnalysis', '‚úÖ No duplicate emails found', 'success');
                    }
                }
            } catch (error) {
                log('dbAnalysis', `‚ùå Error finding duplicates: ${error.message}`, 'error');
            }
        }

        async function findNullEmails() {
            if (!adminToken) {
                log('dbAnalysis', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            log('dbAnalysis', 'üîç Searching for null emails...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const nullEmailUsers = data.verifications.filter(user => !user.email);
                    
                    log('dbAnalysis', `Found ${nullEmailUsers.length} users with null/empty emails:`, 'info');
                    nullEmailUsers.forEach((user, index) => {
                        log('dbAnalysis', `  ${index + 1}. ${user.name} (${user.phone}) - ID: ${user._id}`, 'info');
                    });
                }
            } catch (error) {
                log('dbAnalysis', `‚ùå Error finding null emails: ${error.message}`, 'error');
            }
        }

        async function checkUserSchema() {
            if (!adminToken) {
                log('dbAnalysis', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            log('dbAnalysis', 'üîç Checking user schema...', 'info');
            
            try {
                // Try to create a test user to see what fields are required
                const response = await fetch(`${API_BASE_URL}/auth/firebase`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idToken: 'test-schema-check',
                        role: 'freelancer',
                        phone: '+919999999999'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('dbAnalysis', '‚úÖ Schema check passed - user creation successful', 'success');
                } else {
                    log('dbAnalysis', `‚ùå Schema check failed: ${data.error}`, 'error');
                    log('dbAnalysis', `Error details: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbAnalysis', `‚ùå Schema check error: ${error.message}`, 'error');
            }
        }

        async function searchUser() {
            if (!adminToken) {
                log('userManagement', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            const phone = document.getElementById('searchPhone').value;
            if (!phone) {
                log('userManagement', '‚ùå Please enter a phone number', 'error');
                return;
            }
            
            log('userManagement', `üîç Searching for user with phone: ${phone}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users?phone=${encodeURIComponent(phone)}`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    log('userManagement', '‚úÖ User found:', 'success');
                    log('userManagement', `  ID: ${data.user._id}`, 'info');
                    log('userManagement', `  Name: ${data.user.name}`, 'info');
                    log('userManagement', `  Phone: ${data.user.phone}`, 'info');
                    log('userManagement', `  Email: ${data.user.email || 'NOT SET'}`, 'info');
                    log('userManagement', `  Verified: ${data.user.isVerified}`, 'info');
                    log('userManagement', `  Status: ${data.user.verificationStatus}`, 'info');
                } else {
                    log('userManagement', `‚ùå User not found: ${data.message}`, 'error');
                }
            } catch (error) {
                log('userManagement', `‚ùå Search error: ${error.message}`, 'error');
            }
        }

        async function deleteUser() {
            if (!adminToken) {
                log('userManagement', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            const userId = document.getElementById('deleteUserId').value;
            if (!userId) {
                log('userManagement', '‚ùå Please enter a user ID', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete user ${userId}?`)) {
                return;
            }
            
            log('userManagement', `üóëÔ∏è Deleting user: ${userId}`, 'warning');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/delete-user/${userId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('userManagement', '‚úÖ User deleted successfully', 'success');
                } else {
                    log('userManagement', `‚ùå Failed to delete user: ${data.message}`, 'error');
                }
            } catch (error) {
                log('userManagement', `‚ùå Delete error: ${error.message}`, 'error');
            }
        }

        async function testAuthentication() {
            const phone = document.getElementById('testPhone').value;
            const role = document.getElementById('testRole').value;
            
            log('testResults', `üß™ Testing authentication for phone: ${phone}, role: ${role}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/firebase`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idToken: 'test-token-' + Date.now(),
                        role: role,
                        phone: phone
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('testResults', '‚úÖ Authentication successful!', 'success');
                    log('testResults', `Response: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    log('testResults', `‚ùå Authentication failed: ${response.status}`, 'error');
                    log('testResults', `Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('testResults', `‚ùå Test error: ${error.message}`, 'error');
            }
        }

        async function cleanupNullEmails() {
            if (!adminToken) {
                log('fixResults', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            if (!confirm('This will attempt to clean up users with null emails. Continue?')) {
                return;
            }
            
            log('fixResults', 'üßπ Starting null email cleanup...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const nullEmailUsers = data.verifications.filter(user => !user.email);
                    
                    log('fixResults', `Found ${nullEmailUsers.length} users with null emails`, 'info');
                    
                    for (const user of nullEmailUsers) {
                        log('fixResults', `Deleting user: ${user.name} (${user.phone})`, 'warning');
                        
                        const deleteResponse = await fetch(`${API_BASE_URL}/admin/delete-user/${user._id}`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${adminToken}` }
                        });
                        
                        const deleteData = await deleteResponse.json();
                        
                        if (deleteData.success) {
                            log('fixResults', `‚úÖ Deleted user: ${user.name}`, 'success');
                        } else {
                            log('fixResults', `‚ùå Failed to delete user: ${user.name}`, 'error');
                        }
                    }
                    
                    log('fixResults', '‚úÖ Null email cleanup completed', 'success');
                }
            } catch (error) {
                log('fixResults', `‚ùå Cleanup error: ${error.message}`, 'error');
            }
        }

        async function removeEmailField() {
            if (!adminToken) {
                log('fixResults', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è DANGEROUS: This will attempt to remove the email field from all users. This may cause data loss. Continue?')) {
                return;
            }
            
            log('fixResults', 'üîß Attempting to remove email field...', 'warning');
            
            try {
                // This would require a backend endpoint to handle the schema update
                log('fixResults', '‚ùå This operation requires backend support', 'error');
                log('fixResults', 'Please implement a backend endpoint to handle email field removal', 'info');
            } catch (error) {
                log('fixResults', `‚ùå Remove email field error: ${error.message}`, 'error');
            }
        }

        async function resetDatabase() {
            if (!adminToken) {
                log('fixResults', '‚ùå Please authenticate first', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è DANGEROUS: This will delete ALL users from the database. This action cannot be undone. Continue?')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è FINAL WARNING: Are you absolutely sure you want to delete ALL users?')) {
                return;
            }
            
            log('fixResults', 'üóëÔ∏è Starting database reset...', 'warning');
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('fixResults', `Found ${data.verifications.length} users to delete`, 'warning');
                    
                    for (const user of data.verifications) {
                        log('fixResults', `Deleting user: ${user.name} (${user.phone})`, 'warning');
                        
                        const deleteResponse = await fetch(`${API_BASE_URL}/admin/delete-user/${user._id}`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${adminToken}` }
                        });
                        
                        const deleteData = await deleteResponse.json();
                        
                        if (deleteData.success) {
                            log('fixResults', `‚úÖ Deleted user: ${user.name}`, 'success');
                        } else {
                            log('fixResults', `‚ùå Failed to delete user: ${user.name}`, 'error');
                        }
                    }
                    
                    log('fixResults', '‚úÖ Database reset completed', 'success');
                }
            } catch (error) {
                log('fixResults', `‚ùå Reset error: ${error.message}`, 'error');
            }
        }

        // Auto-authenticate on page load
        window.onload = function() {
            log('authStatus', 'üöÄ Database Debug Tool initialized', 'info');
            log('authStatus', 'Auto-authenticating...', 'info');
            // Set the correct credentials for auto-authentication
            document.getElementById('adminUsername').value = 'admin';
            document.getElementById('adminPassword').value = 'admin123';
            authenticateAdmin();
        };
    </script>
</body>
</html>
